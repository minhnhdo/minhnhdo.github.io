<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Hello, JIT World from D - MrOrdinaire</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header-strip">
            <div id="header">
                <div id="logo">
                    <a href="../index.html">MrOrdinaire</a>
                    <span>Programming and other stuff</span>
                </div>
                <div id="navigation">
                    <a href="../resume.pdf">Résumé</a>
                    <a href="../archive.html">Archive</a>
                    <a href="https://twitter.com/mrordinaire">Twitter</a>
                    <a href="https://github.com/mrordinaire">GitHub</a>
                </div>
            </div>
        </div>

        <div id="container">
            <div id="content">
                <h1>Hello, JIT World from D</h1>

                <div class="info">
  Posted on 2013-01-15
  
</div>


<div class="tags">Tagged with <a href="../tags/just-in-time.html">just-in-time</a>, <a href="../tags/d%20programming%20language.html">d programming language</a>, <a href="../tags/beginner.html">beginner</a> </div>


<article>
<p><em>This post is inspired by <a href="http://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html">Hello, JIT World: The Joy of Simple JITs</a>, especially the first short program that he used to demonstrate that JIT programming can be simple. In this post, I will convert the program he wrote in C to [D][wiki] to show some capabilities and convenience of D.</em></p>
<p>What follows is the whole source of the program in D. You can view the original source in C in the blog post linked above.</p>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="kw">import</span> std.c.string;
<span class="kw">import</span> std.c.linux.linux;
<span class="kw">import</span> std.conv;
<span class="kw">import</span> std.stdio;

<span class="dt">int</span> main(<span class="bu">string</span>[] args)
{
    <span class="co">// Machine code for:</span>
    <span class="co">//   mov eax, 0</span>
    <span class="co">//   ret</span>
    <span class="dt">ubyte</span> code[] = [<span class="bn">0xb8</span>, <span class="bn">0x00</span>, <span class="bn">0x00</span>, <span class="bn">0x00</span>, <span class="bn">0x00</span>, <span class="bn">0xc3</span>];

    <span class="kw">if</span> (args.<span class="dt">length</span> &lt; <span class="dv">2</span>)
    {
        stderr.writeln(<span class="st">&quot;Usage: jit1 &lt;integer&gt;&quot;</span>);
        <span class="kw">return</span> <span class="dv">1</span>;
    }

    <span class="co">// Overwrite immediate value &quot;0&quot; in the instruction</span>
    <span class="co">// with the user's value.  This will make our code:</span>
    <span class="co">//   mov eax, &lt;user's value&gt;</span>
    <span class="co">//   ret</span>
    <span class="dt">int</span> num = to!<span class="dt">int</span>(args[<span class="dv">1</span>]);
    memcpy(&amp;code[<span class="dv">1</span>], &amp;num, <span class="dv">4</span>);

    <span class="co">// Allocate writable/executable memory.</span>
    <span class="co">// Note: real programs should not map memory both writable</span>
    <span class="co">// and executable because it is a security risk.</span>
    <span class="dt">void</span>* mem = mmap(<span class="kw">null</span>, code.<span class="dt">sizeof</span>, PROT_WRITE | PROT_EXEC,
            MAP_ANON | MAP_PRIVATE, -<span class="dv">1</span>, <span class="dv">0</span>);
    memcpy(mem, code, code.<span class="dt">sizeof</span>);

    <span class="co">// The function will return the user's value.</span>
    <span class="dt">int</span> <span class="kw">function</span>() func = <span class="kw">cast</span>(<span class="dt">int</span> <span class="kw">function</span>())mem;
    <span class="kw">return</span> func();
}</code></pre></div>
<p>Let’s go through some first impressions.</p>
<p>D programming language is in the same family of languages that have the C flavor, so you might already find the code familiar and quite easy to read. Some familiarities are</p>
<ul>
<li>double forward slashes starts a line comment</li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="co">// a line comment which extends only to the end of the line</span></code></pre></div>
<ul>
<li>curly braces around a block of code</li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d">{
    <span class="co">// block of code</span>
}</code></pre></div>
<ul>
<li>every statement ends in a semicolon</li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d">statement; <span class="co">// assuming you have statement defined</span></code></pre></div>
<ul>
<li>type goes before the identifier in a declaration</li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="dt">int</span> a;
<span class="dt">long</span> b;</code></pre></div>
<ul>
<li>all executions start from the <code>main</code> function which can have one of the following signatures</li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="dt">int</span> main();
<span class="dt">int</span> main(<span class="bu">string</span>[]);
<span class="dt">void</span> main();
<span class="dt">void</span> main(<span class="bu">string</span>[]);</code></pre></div>
<ul>
<li>and unlike C (or C++ for that matter), the D standard actually have <code>void main(...)</code> functions return 0 (which means success) to the shell.</li>
<li>indexing operator is <code>[]</code></li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="dt">int</span>[<span class="dv">2</span>] a;
a[<span class="dv">1</span>] = <span class="dv">1</span>; <span class="co">// use this to index into the second element of a</span></code></pre></div>
<ul>
<li>address-of operator is <code>&amp;</code></li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="dt">int</span> a;
<span class="dt">int</span>* b = &amp;a;</code></pre></div>
<ul>
<li>from the above example you can also see that there are pointer types in D and the syntax for declaring one is just like C’s</li>
<li>there’s actually a <code>null</code> value for pointers, not just a cast from zero as in C</li>
<li>bitwise operators in D are the same as in C, e.g. <code>|</code>, <code>&amp;</code> and <code>~</code></li>
<li>you can cast from one time to another, which is not recommended unless you know exactly what you are doing as the safe subset of D is powerful enough for most applications, by doing</li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="dt">void</span>* a;
<span class="dt">char</span>* b = <span class="kw">cast</span>(<span class="dt">char</span>*)a;</code></pre></div>
<ul>
<li>syntax for returning from a function is</li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="kw">return</span> expression; <span class="co">// where expression is any expression, e.g. 1 + 1</span></code></pre></div>
<p>So D is quite similar to C/C++. But the differences that set D apart is even more interesting.</p>
<ul>
<li>there is a concept of modules that can <code>import</code> each other, so that a source file does not have to be processed so many times in compilation (well, there’s more to this but the reduction in compilation time that comes with this is, to me, the most significant benefit)</li>
<li>string is actually supported, not something that feels bolted on like in C (or C++)</li>
<li>there’s no <code>unsigned</code> keyword. Most types have their unsigned counterparts named with a <code>u</code> prepended.</li>
<li>arrays know their own lengths, which can be accessed by doing</li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="dt">int</span>[<span class="dv">200</span>] a;
writeln(a.<span class="dt">length</span>); <span class="co">// assuming you have `import std.stdio;` before this.</span>
<span class="co">// Prints out 200.</span></code></pre></div>
<ul>
<li><code>to</code> in <code>to!int</code> is a generic function (and you specialize it using the bang-type syntax). The syntax, though unfamiliar, but greatly simplifies parsing, both for compilers and for humans.</li>
<li>C code can be called directly from D after creating declarations for it. The function <code>memcpy</code> and <code>mmap</code> are C functions whose declarations are defined in packages <code>string</code> and <code>linux</code>.</li>
<li>the size of some variable in bytes can be obtained from doing <code>variable.sizeof</code></li>
<li>any pointer type is automatically convertible to <code>void*</code>, not so for the converse.</li>
<li>there is a <code>function</code> keyword so that the type of a function pointer or complex types can be declared without hurting your brain</li>
</ul>
<div class="sourceCode"><pre class="sourceCode d"><code class="sourceCode d"><span class="co">// fp is a pointer to a function that takes a function taking a char</span>
<span class="co">// returning an int and returns a typeless pointer</span>
<span class="co">// (try saying that five times fast)</span>
<span class="dt">void</span>* <span class="kw">function</span>(<span class="dt">int</span> <span class="kw">function</span>(<span class="dt">char</span>)) fp;
<span class="co">// the equivalent for that in C is</span>
<span class="co">// void* (*fp)(int (*)(char));</span>

<span class="co">// let's look at something more interesting</span>
<span class="co">// signal is a function that takes an int and a pointer to a function</span>
<span class="co">// taking an int returning nothing and returns a pointer to a function</span>
<span class="co">// taking an int returning nothing</span>
<span class="dt">void</span> <span class="kw">function</span>(<span class="dt">int</span>) signal(<span class="dt">int</span> sig, <span class="dt">void</span> <span class="kw">function</span>(<span class="dt">int</span>) func));
<span class="co">// the equivalent for that in C is</span>
<span class="co">// void (*signal (int sig, void (*func)(int)) )(int);</span>
<span class="co">// try reading that five times fast :)</span></code></pre></div>
<p>Those are the differences that are present in this code snippet, you can check out more about D at the <a href="http://dlang.org">D home page</a> or a summary at the <a href="http://en.wikipedia.org/wiki/D_(programming_language)">wikipedia page</a>.</p>
</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'minhdo'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
        </div>
        <div id="footer-strip">
            <div id="footer">
                Site proudly generated by
                <a href="http://jaspervdj.be/hakyll/">Hakyll</a>
                and
                <a href="http://fvisser.nl/clay/">Clay</a>
                <br />
                with
                <a href="http://ethanschoonover.com/solarized">Solarized</a>
                color scheme.
            </div>
        </div>
    </body>
</html>
