<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Hacking on coleslaw - MrOrdinaire</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header-strip">
            <div id="header">
                <div id="logo">
                    <a href="../index.html">MrOrdinaire</a>
                    <span>Programming and other stuff</span>
                </div>
                <div id="navigation">
                    <a href="../resume.pdf">Résumé</a>
                    <a href="../archive.html">Archive</a>
                    <a href="https://twitter.com/mrordinaire">Twitter</a>
                    <a href="https://github.com/mrordinaire">GitHub</a>
                </div>
            </div>
        </div>

        <div id="container">
            <div id="content">
                <h1>Hacking on coleslaw</h1>

                <div class="info">
  Posted on 2013-04-19
  
</div>


<div class="tags">Tagged with <a href="../tags/hack.html">hack</a>, <a href="../tags/common%20lisp.html">common lisp</a>, <a href="../tags/coleslaw.html">coleslaw</a>, <a href="../tags/github.html">github</a>, <a href="../tags/pages.html">pages</a> </div>


<article>
<p><em>In this post, I document how I hacked <a href="https://github.com/redline6561/coleslaw">coleslaw</a> to add <a href="http://pages.github.com/">Github’s pages</a> integration.</em></p>
<h2 id="what-is-coleslaw">What is coleslaw?</h2>
<p>coleslaw is a static blog generator written in Common Lisp, much like <a href="http://jekyllrb.com/">Jekyll</a>, albeit with less features.</p>
<p>I’ve been using <a href="http://octopress.org/">Octopress</a> to generate this site. Since I don’t know <a href="http://ruby-lang.org/">Ruby</a>, and have to intention to learn it, I can’t hack on Octopress’s code nor on Jekyll’s, which is a shame. As I am learning <a href="http://en.wikipedia.org/wiki/Common_Lisp/">Common Lisp</a>, and wanting to work on something in it, switching to coleslaw seems perfect for me.</p>
<h2 id="trying-coleslaw-out">Trying coleslaw out</h2>
<p>Here’s how I set up and use coleslaw.</p>
<ul>
<li>Install <a href="http://git-scm.com/">git</a></li>
<li>Set up a bare git repo</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="bu">cd</span> /path/to/repo <span class="co"># this is where the post-receive script is put</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="fu">git</span> --bare init</a></code></pre></div>
<ul>
<li>Install Lisp (I choose <a href="http://sbcl.org/">sbcl</a>)</li>
<li>Install <a href="http://quicklisp.org/">Quicklisp</a></li>
<li>Get coleslaw’s settings file</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">wget</span> -c https://raw.github.com/redline6561/coleslaw/master/examples/single-site.coleslawrc \</a>
<a class="sourceLine" id="cb2-2" title="2">     -O ~/.coleslawrc</a></code></pre></div>
<ul>
<li>The settings must be edited accordingly. I find the naming a bit confusing, so I have put some comment below for clarification.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><a class="sourceLine" id="cb3-1" title="1">(:author <span class="st">&quot;Example Setter&quot;</span></a>
<a class="sourceLine" id="cb3-2" title="2"> :deploy <span class="st">&quot;/path/to/deploy&quot;</span> <span class="co">; this is where coleslaw writes its output</span></a>
<a class="sourceLine" id="cb3-3" title="3"> :domain <span class="st">&quot;http://blog.example.com&quot;</span></a>
<a class="sourceLine" id="cb3-4" title="4"> :feeds (<span class="st">&quot;lisp&quot;</span>)</a>
<a class="sourceLine" id="cb3-5" title="5"> :plugins ((mathjax)</a>
<a class="sourceLine" id="cb3-6" title="6">           (disqus :shortname <span class="st">&quot;my-site-name&quot;</span>)</a>
<a class="sourceLine" id="cb3-7" title="7">           (analytics :tracking-code <span class="st">&quot;foo&quot;</span>))</a>
<a class="sourceLine" id="cb3-8" title="8"> <span class="co">;; this is where coleslaw writes its temporary output, which gets moved</span></a>
<a class="sourceLine" id="cb3-9" title="9"> <span class="co">;; into :DEPLOY</span></a>
<a class="sourceLine" id="cb3-10" title="10"> :repo <span class="st">&quot;/path/to/some/temporary/folder/&quot;</span></a>
<a class="sourceLine" id="cb3-11" title="11"> :sitenav ((:url <span class="st">&quot;http://example.com/&quot;</span> <span class="bu">:name</span> <span class="st">&quot;Home&quot;</span>)</a>
<a class="sourceLine" id="cb3-12" title="12">           (:url <span class="st">&quot;http://twitter.com/example&quot;</span> <span class="bu">:name</span> <span class="st">&quot;Twitter&quot;</span>)</a>
<a class="sourceLine" id="cb3-13" title="13">           (:url <span class="st">&quot;http://github.com/example&quot;</span> <span class="bu">:name</span> <span class="st">&quot;Code&quot;</span>))</a>
<a class="sourceLine" id="cb3-14" title="14"> :title <span class="st">&quot;Blog title&quot;</span></a>
<a class="sourceLine" id="cb3-15" title="15"> :theme <span class="st">&quot;hyde&quot;</span>)</a></code></pre></div>
<ul>
<li>Get <code>post-receive</code> hook script and edit the file according to the instructions inside</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1"><span class="fu">wget</span> -c https://raw.github.com/redline6561/coleslaw/master/examples/example.post-receive \</a>
<a class="sourceLine" id="cb4-2" title="2">     -O /path/to/repo/hooks/post-receive</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co"># edit the file</span></a></code></pre></div>
<ul>
<li>Make the script executable</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1"><span class="fu">chmod</span> +x /path/to/repo/hooks/post-receive</a></code></pre></div>
<ul>
<li>Create another repository to hold posts</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="bu">cd</span> /path/to/posts</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="fu">git</span> init</a></code></pre></div>
<ul>
<li>Add the bare repo as a remote of the posts repo</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="fu">git</span> remote add prod file:///path/to/repo/</a></code></pre></div>
<ul>
<li>Use a server of choice to serve the site. Here I choose <a href="http://php.net/">PHP</a>’s built in server.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="bu">cd</span> /path/to/deploy/.curr/</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="ex">php</span> -S localhost:8080</a></code></pre></div>
<h2 id="motivation">Motivation</h2>
<p>As I want to put my blog on Github’s pages with my custom domain, I need the generator to put a file named <code>CNAME</code>, whose content is my custom domain name, in the root of the generated site. However, currently coleslaw only recognizes files with <code>post</code> extension, along with files in the <code>static</code> folder, and does not allow putting custom files in the root of the site. I need to hack up a way to generate that <code>CNAME</code> file under the root of the site.</p>
<h2 id="forking-the-code">Forking the code</h2>
<p>The usual workflow on Github is to fork the code, hack on it, commit and then send a pull request to the original author.</p>
<p>After forking the code and cloning it to my machine, I need to setup Quicklisp’s quickproject according to <a href="http://xach.livejournal.com/278047.html">this</a> so that it sees my code.</p>
<p>Since I have generated the posts using coleslaw, Quicklisp must have pulled the code from its repository. For safety, I uninstall Quicklisp’s coleslaw.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><a class="sourceLine" id="cb9-1" title="1"><span class="co">;; start sbcl and load Quicklisp's setup.lisp</span></a>
<a class="sourceLine" id="cb9-2" title="2">(<span class="kw">use-package</span> :ql-dist)</a>
<a class="sourceLine" id="cb9-3" title="3">(uninstall (release <span class="st">&quot;coleslaw&quot;</span>))</a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co">; instructions gotten from</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">;   https://groups.google.com/forum/?fromgroups=#!topic/quicklisp/CvB3mwsL7l4</span></a></code></pre></div>
<h2 id="hack-on-it">Hack on it</h2>
<p>I add a property to class <code>blog</code> in order to capture user’s intent to integrate with Github’s pages.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><a class="sourceLine" id="cb10-1" title="1"><span class="co">; in src/config.lisp</span></a>
<a class="sourceLine" id="cb10-2" title="2">(<span class="kw">defclass</span><span class="fu"> blog </span>()</a>
<a class="sourceLine" id="cb10-3" title="3">  (</a>
<a class="sourceLine" id="cb10-4" title="4">   <span class="co">; [...]</span></a>
<a class="sourceLine" id="cb10-5" title="5">   (github :initarg :github :initform <span class="kw">nil</span> :accessor github)</a>
<a class="sourceLine" id="cb10-6" title="6">   <span class="co">; [...]</span></a>
<a class="sourceLine" id="cb10-7" title="7">   ))</a></code></pre></div>
<p>And then the code to actually generate the <code>CNAME</code> file</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><a class="sourceLine" id="cb11-1" title="1">(<span class="kw">defgeneric</span><span class="fu"> deploy </span>(staging)</a>
<a class="sourceLine" id="cb11-2" title="2">  (((</a>
<a class="sourceLine" id="cb11-3" title="3">        <span class="co">; [...]</span></a>
<a class="sourceLine" id="cb11-4" title="4">        (run-program <span class="st">&quot;mv ~a ~a&quot;</span> staging new-build)</a>
<a class="sourceLine" id="cb11-5" title="5">        (<span class="kw">when</span> (github *config*)</a>
<a class="sourceLine" id="cb11-6" title="6">          (<span class="kw">let</span> ((cname-filename (rel-path <span class="st">&quot;&quot;</span> <span class="st">&quot;~a/CNAME&quot;</span> new-build))</a>
<a class="sourceLine" id="cb11-7" title="7">                (stripped-url (<span class="kw">subseq</span> (domain *config*)</a>
<a class="sourceLine" id="cb11-8" title="8">                                      (<span class="op">+</span> <span class="dv">2</span> (<span class="kw">position</span> <span class="ch">#\/</span> (domain *config*))))))</a>
<a class="sourceLine" id="cb11-9" title="9">            (<span class="kw">with-open-file</span> (cname cname-filename</a>
<a class="sourceLine" id="cb11-10" title="10">                                   <span class="bu">:direction</span> <span class="bu">:output</span></a>
<a class="sourceLine" id="cb11-11" title="11">                                   :if-exists <span class="bu">:supersede</span>)</a>
<a class="sourceLine" id="cb11-12" title="12">              (<span class="kw">format</span> cname <span class="st">&quot;~a~%&quot;</span> stripped-url))))</a>
<a class="sourceLine" id="cb11-13" title="13">        (<span class="kw">when</span> (<span class="kw">probe-file</span> prev)</a>
<a class="sourceLine" id="cb11-14" title="14">        <span class="co">; [...]</span></a>
<a class="sourceLine" id="cb11-15" title="15">        )))))</a></code></pre></div>
<h2 id="not-send-a-pull-request-to-the-original-author">(Not) Send a pull request to the original author</h2>
<p>Since the way I pulled out the domain name from the <code>blog</code> object is very ad-hoc, I don’t think this code is production quality yet. I should write a separate library to parse the url and then use that to robustly extract the domain name. Until then, I won’t send a pull request to the original author.</p>
</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'minhdo'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
        </div>
        <div id="footer-strip">
            <div id="footer">
                Site proudly generated by
                <a href="http://jaspervdj.be/hakyll/">Hakyll</a>
                and
                <a href="http://fvisser.nl/clay/">Clay</a>
                <br />
                with
                <a href="http://ethanschoonover.com/solarized">Solarized</a>
                color scheme.
            </div>
        </div>
    </body>
</html>
