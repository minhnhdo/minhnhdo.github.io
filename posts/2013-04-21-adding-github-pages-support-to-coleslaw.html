<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Adding Github Pages Support to Coleslaw - MrOrdinaire</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    </head>
    <body>
        <div id="header-strip">
            <div id="header">
                <div id="logo">
                    <a href="../">MrOrdinaire</a>
                    <span>Programming and other stuff</span>
                </div>
                <div id="navigation">
                    <a href="../resume.pdf">Resumé</a>
                    <a href="../archive.html">Archives</a>
                    <a href="https://twitter.com/mrordinaire">Twitter</a>
                    <a href="https://github.com/mrordinaire">GitHub</a>
                </div>
            </div>
        </div>

        <div id="container">
            <div id="content">
                <h1>Adding Github Pages Support to Coleslaw</h1>

                <div class="info">Posted on April 21, 2013</div>

<article>
<p><em>This post wraps up how I hacked <a href="https://github.com/redline6561/coleslaw">coleslaw</a> to add <a href="http://pages.github.com/">Github pages</a> integration.</em></p>
<h2 id="whats-missing">What’s missing</h2>
<ol style="list-style-type: decimal">
<li>Github pages does not support symlinks. Therefore, instead of symlinking <code>index.html</code> to <code>1.html</code>, I should just copy <code>1.html</code> as <code>index.html</code>.</li>
<li>I need a way to robustly parse the domain given in <code>~/.coleslawrc</code>.</li>
</ol>
<h2 id="fixing-it">Fixing it</h2>
<h3 id="symlinks">Symlinks</h3>
<p>For the symlinking problem, I can just change the code from symlinking to copying it over. However, it is safer to change the behavior of the code only when the user explicitly asks for it.</p>
<p>Grepping through the code, I can see that <code>render-indices</code> produces the indices, e.g. <code>1.html</code>, etc., and symlinking <code>1.html</code> to <code>index.html</code>. This is where I should make the modification. I added another argument to <code>render-indices</code> to tell the code to make the symlink or not.</p>
<pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><span class="co">;;;; in src/coleslaw.lisp</span>
<span class="co">; [...]</span>
      (<span class="kw">when</span> (<span class="kw">probe-file</span> dir)
        (run-program <span class="st">&quot;cp -R ~a .&quot;</span> dir)))
    (do-ctypes (publish ctype))
    (render-indices (<span class="kw">not</span> (github-pages *config*)))
    (render-feeds (feeds *config*))))
<span class="co">; [...]</span>

<span class="co">;;;; in src/indices.lisp</span>
<span class="co">; [...]</span>
                              :posts (<span class="kw">subseq</span> content start end)
                              :title <span class="st">&quot;Recent Posts&quot;</span>)))

(<span class="kw">defun</span><span class="fu"> render-indices </span>(make-symlink-p)
  <span class="st">&quot;Render the indices to view content in groups of size N, by month, and by tag&quot;</span>
  (<span class="kw">let</span> ((results (by-date (hash-table-values *content*))))
    (<span class="kw">dolist</span> (tag (all-tags))
<span class="co">; [...]</span>
                                  :prev (<span class="kw">and</span> (<span class="kw">plusp</span> i) i)
                                  :next (<span class="kw">and</span> (<span class="kw">&lt;</span> (<span class="kw">*</span> (<span class="kw">1+</span> i) <span class="dv">10</span>) (<span class="kw">length</span> results))
                                             (<span class="kw">+</span> <span class="dv">2</span> i)))))))
  (<span class="kw">if</span> make-symlink-p
    (update-symlink <span class="st">&quot;index.html&quot;</span> <span class="st">&quot;1.html&quot;</span>)
    (run-program <span class="st">&quot;cp 1.html index.html&quot;</span>))</code></pre>
<h3 id="domain">Domain</h3>
<p>Previously, my ad-hoc solution was to find the first forward-slash in the domain string and substring the domain string from after the second forward-slash. Here’s the previous code.</p>
<pre class="sourceCode commonlisp"><code class="sourceCode commonlisp">(<span class="kw">defgeneric</span><span class="fu"> deploy </span>(staging)
  (((
        <span class="co">; [...]</span>
        (run-program <span class="st">&quot;mv ~a ~a&quot;</span> staging new-build)
        (<span class="kw">when</span> (github *config*)
          (<span class="kw">let</span> ((cname-filename (rel-path <span class="st">&quot;&quot;</span> <span class="st">&quot;~a/CNAME&quot;</span> new-build))
                (stripped-url (<span class="kw">subseq</span> (domain *config*)
                                      (<span class="kw">+</span> <span class="dv">2</span> (<span class="kw">position</span> <span class="ch">#\/</span> (domain *config*))))))
            (<span class="kw">with-open-file</span> (cname cname-filename
                                   <span class="kw">:direction</span> <span class="kw">:output</span>
                                   :if-exists <span class="kw">:supersede</span>)
              (<span class="kw">format</span> cname <span class="st">&quot;~a~%&quot;</span> stripped-url))))
        (<span class="kw">when</span> (<span class="kw">probe-file</span> prev)
        <span class="co">; [...]</span>
        )))))</code></pre>
<p>Now, I can instead use the <a href="http://puri.b9.com/">puri</a> library to parse the URL and extract only the domain. Here’s the new code using <code>puri</code>.</p>
<pre class="sourceCode commonlisp"><code class="sourceCode commonlisp">(<span class="kw">defgeneric</span><span class="fu"> deploy </span>(staging)
  (((
        <span class="co">; [...]</span>
        (run-program <span class="st">&quot;mv ~a ~a&quot;</span> staging new-build)
        (<span class="kw">when</span> (github *config*)
          (<span class="kw">let</span> ((cname-filename (rel-path <span class="st">&quot;&quot;</span> <span class="st">&quot;~a/CNAME&quot;</span> new-build))
                (stripped-url (puri:uri-host (puri:parse-uri
                                               (domain *config*)))))
            (<span class="kw">with-open-file</span> (cname cname-filename
                                   <span class="kw">:direction</span> <span class="kw">:output</span>
                                   :if-exists <span class="kw">:supersede</span>)
              (<span class="kw">format</span> cname <span class="st">&quot;~a~%&quot;</span> stripped-url))))
        (<span class="kw">when</span> (<span class="kw">probe-file</span> prev)
        <span class="co">; [...]</span>
        )))))</code></pre>
<p>Of course, I need to add puri as a dependency to coleslaw.</p>
<pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><span class="co">;;;; in coleslaw.asd</span>
               :inferior-shell
               :cl-fad
               :cl-ppcre
               :closer-mop
               :puri)
  :serial <span class="kw">t</span>
  :components ((:file <span class="st">&quot;packages&quot;</span>)
               (:file <span class="st">&quot;util&quot;</span></code></pre>
<h2 id="really-wrap-up">Really Wrap Up</h2>
<p>All that’s left now is to send a pull request to the original author, which I have already done.</p>
</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'minhdo'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
        </div>
        <div id="footer-strip">
            <div id="footer">
                Site proudly generated by
                <a href="http://jaspervdj.be/hakyll">Hakyll</a>
                and
                <a href="http://fvisser.nl/clay/">Clay</a>.
                <br />
                <a href="http://ethanschoonover.com/solarized">Solarized</a>
                color scheme by Ethan Schoonover.
            </div>
        </div>
    </body>
</html>
