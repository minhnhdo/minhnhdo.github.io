<!doctype html>
<html> <head> <title>MrOrdinaire</title> <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" /> <link href="http://fonts.googleapis.com/css?family=Vollkorn:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" /> <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /> <link href= "http://minhdo.org/css/style.css" rel="stylesheet" type="text/css" /> <link rel="alternate" href="http://minhdo.org/rss.xml" type="application/rss+xml" />  </head> <body> <div class="navigation"> <a href="http://minhdo.org">MrOrdinaire</a> | <a href="http://twitter.com/mrordinaire">Twitter</a>  | <a href="http://github.com/mrordinaire">Github</a>  </div> <div id="content"> <div class="article-meta">
<h1 class="title">Adding Github Pages Support to Coleslaw</h1>
<div class="tags">
Tagged as <a href="../tag/hack.html">hack</a>, <a href="../tag/common-lisp.html">common lisp</a>, <a href="../tag/coleslaw.html">coleslaw</a>, <a href="../tag/github.html">github</a>, <a href="../tag/pages.html">pages</a> </div>
<div class="date">
Written on 2013-04-21 21:40:32 </div>
</div>
<div class="article-content">


<p><em>This post wraps up how I hacked <a href="https://github.com/redline6561/coleslaw" >coleslaw</a> to add <a href="http://pages.github.com/" >Github pages</a> integration.</em></p>

<h2>What's missing</h2>

<ol>
<li>Github pages does not support symlinks. Therefore, instead of symlinking <code>index.html</code> to <code>1.html</code>, I should just copy <code>1.html</code> as <code>index.html</code>.</li>
<li>I need a way to robustly parse the domain given in <code>~/.coleslawrc</code>.</li>
</ol>

<h2>Fixing it</h2>

<h3>Symlinks</h3>

<p>For the symlinking problem, I can just change the code from symlinking to copying it over. However, it is safer to change the behavior of the code only when the user explicitly asks for it.</p>

<p>Grepping through the code, I can see that <code>render-indices</code> produces the indices, e.g. <code>1.html</code>, etc., and symlinking <code>1.html</code> to <code>index.html</code>. This is where I should make the modification. I added another argument to <code>render-indices</code> to tell the code to make the symlink or not.</p>

<pre><code><span class="code"><span class="comment">;;;; in src/coleslaw.lisp
</span><span class="comment">; [...]
</span>      <span class="paren1">(<span class="code">when <span class="paren2">(<span class="code">probe-file dir</span>)</span>
        <span class="paren2">(<span class="code">run-program <span class="string">"cp -R ~a ."</span> dir</span>)</span></span>)</span>)
    <span class="paren1">(<span class="code">do-ctypes <span class="paren2">(<span class="code">publish ctype</span>)</span></span>)</span>
    <span class="paren1">(<span class="code">render-indices <span class="paren2">(<span class="code">not <span class="paren3">(<span class="code">github-pages <span class="special">*config*</span></span>)</span></span>)</span></span>)</span>
    <span class="paren1">(<span class="code">render-feeds <span class="paren2">(<span class="code">feeds <span class="special">*config*</span></span>)</span></span>)</span>))
<span class="comment">; [...]
</span>
;;;; in src/indices.lisp
<span class="comment">; [...]
</span>                              :posts <span class="paren1">(<span class="code">subseq content start end</span>)</span>
                              :title "Recent Posts")))

<span class="paren1">(<span class="code"><i><span class="symbol">defun</span></i> render-indices <span class="paren2">(<span class="code">make-symlink-p</span>)</span>
  <span class="string">"Render the indices to view content in groups of size N, by month, and by tag
  (let ((results (by-date (hash-table-values *content*))))
    (dolist (tag (all-tags))
; [...]
                                  :prev (and (plusp i) i)
                                  :next (and (&lt; (* (1+ i) 10) (length results))
                                             (+ 2 i)))))))
  (if make-symlink-p
    (update-symlink "</span>index.html<span class="string">" "</span>1.html<span class="string">")
    (run-program "</span>cp 1.html index.html<span class="string">"))</span></span></span></span></code></pre>

<h3>Domain</h3>

<p>Previously, my ad-hoc solution was to find the first forward-slash in the domain string and substring the domain string from after the second forward-slash. Here's the previous code.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defgeneric</span></i> deploy <span class="paren2">(<span class="code">staging</span>)</span>
  <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">
        <span class="comment">; [...]
</span>        <span class="paren5">(<span class="code">run-program <span class="string">"mv ~a ~a"</span> staging new-build</span>)</span>
        <span class="paren5">(<span class="code">when <span class="paren6">(<span class="code">github <span class="special">*config*</span></span>)</span>
          <span class="paren6">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren1">(<span class="code"><span class="paren2">(<span class="code">cname-filename <span class="paren3">(<span class="code">rel-path <span class="string">""</span> <span class="string">"~a/CNAME"</span> new-build</span>)</span></span>)</span>
                <span class="paren2">(<span class="code">stripped-url <span class="paren3">(<span class="code">subseq <span class="paren4">(<span class="code">domain <span class="special">*config*</span></span>)</span>
                                      <span class="paren4">(<span class="code">+ 2 <span class="paren5">(<span class="code">position <span class="character">#\/</span> <span class="paren6">(<span class="code">domain <span class="special">*config*</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
            <span class="paren1">(<span class="code"><i><span class="symbol">with-open-file</span></i> <span class="paren2">(<span class="code">cname cname-filename
                                   <span class="keyword">:direction</span> <span class="keyword">:output</span>
                                   <span class="keyword">:if-exists</span> <span class="keyword">:supersede</span></span>)</span>
              <span class="paren2">(<span class="code">format cname <span class="string">"~a~%"</span> stripped-url</span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">when <span class="paren6">(<span class="code">probe-file prev</span>)</span>
        <span class="comment">; [...]
</span>        </span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Now, I can instead use the <a href="http://puri.b9.com/" >puri</a> library to parse the URL and extract only the domain. Here's the new code using <code>puri</code>.</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">defgeneric</span></i> deploy <span class="paren2">(<span class="code">staging</span>)</span>
  <span class="paren2">(<span class="code"><span class="paren3">(<span class="code"><span class="paren4">(<span class="code">
        <span class="comment">; [...]
</span>        <span class="paren5">(<span class="code">run-program <span class="string">"mv ~a ~a"</span> staging new-build</span>)</span>
        <span class="paren5">(<span class="code">when <span class="paren6">(<span class="code">github <span class="special">*config*</span></span>)</span>
          <span class="paren6">(<span class="code"><i><span class="symbol">let</span></i> <span class="paren1">(<span class="code"><span class="paren2">(<span class="code">cname-filename <span class="paren3">(<span class="code">rel-path <span class="string">""</span> <span class="string">"~a/CNAME"</span> new-build</span>)</span></span>)</span>
                <span class="paren2">(<span class="code">stripped-url <span class="paren3">(<span class="code">puri:uri-host <span class="paren4">(<span class="code">puri:parse-uri
                                               <span class="paren5">(<span class="code">domain <span class="special">*config*</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
            <span class="paren1">(<span class="code"><i><span class="symbol">with-open-file</span></i> <span class="paren2">(<span class="code">cname cname-filename
                                   <span class="keyword">:direction</span> <span class="keyword">:output</span>
                                   <span class="keyword">:if-exists</span> <span class="keyword">:supersede</span></span>)</span>
              <span class="paren2">(<span class="code">format cname <span class="string">"~a~%"</span> stripped-url</span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">when <span class="paren6">(<span class="code">probe-file prev</span>)</span>
        <span class="comment">; [...]
</span>        </span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>Of course, I need to add puri as a dependency to coleslaw.</p>

<pre><code><span class="code"><span class="comment">;;;; in coleslaw.asd
</span>               :inferior-shell
               :cl-fad
               :cl-ppcre
               :closer-mop
               :puri)
  :serial t
  :components <span class="paren1">(<span class="code"><span class="paren2">(<span class="code"><span class="keyword">:file</span> <span class="string">"packages"</span></span>)</span>
               <span class="paren2">(<span class="code"><span class="keyword">:file</span> <span class="string">"util"</span></span></span></span></span></span></code></pre>

<h2>Really Wrap Up</h2>

<p>All that's left now is to send a pull request to the original author, which I have already done.</p>
 </div>
<div class="relative-nav">
<a href="http://minhdo.org/posts/Hacking-on-coleslaw.html">Previous</a><br>

</div>
 </div> <div id="disqus_thread"></div>
     <script type="text/javascript">
       /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
       var disqus_shortname = 'minhdo';
       /* * * DON'T EDIT BELOW THIS LINE * * */
       (function() {
         var dsq = document.createElement('script');
         dsq.type = 'text/javascript';
         dsq.async = true;
         dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
           })();
     </script>
     <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
     <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> <div class="fineprint"> <hr> Unless otherwise credited all material <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"> <img alt="Creative Commons License" style="border-width:0" src="http://minhdo.org/css/cc-by-sa.png" /> </a> by Do Nhat Minh <img align="right" src="http://minhdo.org/css/logo_small.jpg" /> </div> </body> </html>
